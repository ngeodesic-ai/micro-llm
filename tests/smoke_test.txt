git branch -D defi_poc_v2
git push origin --delete defi_poc_v2
git reset --hard HEAD~5 

python3 -m pip uninstall -y micro-lm micro_lm   
python3 -m pip install -e . 

pytest -v
pytest -q  

export MICROLLM_DEBUG=1
unset MICROLLM_DEBUG

micro-arc --prompt "flip the grid horizontally" --rails stage11
micro-defi --prompt "deposit 10 ETH into aave" --rails stage11 

micro-defi -p "withdraw 5 ETH" --rails stage11 \
  --policy '{"ltv_max":0.60,"audit":{"backend":"wdd"}}' \
  --context '{"oracle":{"age_sec":5,"max_age_sec":30},"risk":{"hf":1.15}}' \
  --verbose


MICRO_LM_WDD_DEBUG=1 \
python3 -m micro_lm.cli.defi_quickstart "deposit 10 ETH into aave" \
  --rails stage11 --verbose \
  --policy '{"audit":{"backend":"wdd"}}'

python3 -m micro_lm.cli.arc_quickstart \
  --prompt "flip the grid horizontally then rotate it" \
  --grid '[[3,0,1,2],[3,2,1,0],[3,2,0,5],[6,1,4,2]]' \
  --mode family \
  --rails stage11 \
  --verbose \
  --policy_json '{"audit":{"backend":"wdd"}}'

python3 -m micro_lm.cli.arc_quickstart \
  --prompt "rotate the grid 90 degrees clockwise, then flip it horizontally" \
  --grid '[[3,0,1,2],[3,2,1,0],[3,2,0,5],[6,1,4,2]]' \
  --mode family \
  --rails stage11 \
  --verbose \
  --policy_json '{"audit":{"backend":"wdd"}}'


python3 -m micro_lm.cli.defi_quickstart "swap 2 ETH for USDC" \
  --rails stage11 --verbose \
  --policy '{"audit":{"backend":"wdd","mode":"family","K":12,"template_width":64,"z_abs":0.55,"keep_frac":0.70}}'


python3 - <<'PY'
from micro_lm.adapters.defi.mapper import map_prompt
for t in ["check balance", "view my positions", "what's my health factor"]:
    slots, conf = map_prompt(t, {}, {"model_path": ".artifacts/defi_mapper.joblib"})
    print(t, "->", slots, conf)
PY

python3 - <<'PY'                                               
import micro_lm, inspect, os
print("micro_lm:", micro_lm.__file__)
PY

python3 - <<'PY'                                               
from micro_lm.adapters.arc import ARCAdapter
from micro_lm.adapters.defi import DeFiAdapter
print("ARC ok:", ARCAdapter)
print("DeFi ok:", DeFiAdapter)
PY

python3 - <<'PY'                                               
from micro_lm.pipelines.runner import run_micro
print("runner import OK")                      
PY  

python3 - <<'PY'                                               
from micro_lm.adapters import get_adapter_for_domain
print(type(get_adapter_for_domain("arc")).__name__)
print(type(get_adapter_for_domain("defi")).__name__)
PY

python3 - <<'PY'
from micro_lm.pipelines.runner import run_micro
res = run_micro(
  domain="defi",
  prompt="borrow 500 USDC",
  context={"positions":{"collateral_value":1000.0,"debt_value":900.0}},
  policy={"ltv_max":0.75,"liq_threshold":0.85},
  rails="stage11", T=180
)
import json; print(json.dumps(res["verify"], indent=2))
PY
{
  "ok": false,
  "reason": "hf_too_low_for_borrow"
}



python3 milestones/defi_milestone1.py --rails stage11 \
  --policy '{"mapper":{"model_path":".artifacts/defi_mapper.joblib","confidence_threshold":0.7},"ltv_max":0.75}'
python3 milestones/defi_milestone2.py --rails stage11 --runs 10 \
  --policy '{"rails":{"denoise": false},"ltv_max":0.75}' \
  --context '{"oracle":{"age_sec":5,"max_age_sec":30}}'
python3 milestones/defi_milestone3.py --rails stage11 --runs 10 \
  --policy '{"mapper":{"model_path":".artifacts/defi_mapper.joblib","confidence_threshold":0.7},"ltv_max":0.75}'
python3 milestones/defi_milestone4.py --rails stage11 --runs 10 \
  --policy '{"mapper":{"model_path":".artifacts/defi_mapper.joblib","confidence_threshold":0.7},"ltv_max":0.75}'
python3 milestones/defi_milestone5.py --rails stage11 --runs 10 \
  --policy '{"ltv_max":0.75,"mapper":{"model_path":".artifacts/defi_mapper.joblib","confidence_threshold":0.7}}' \
  --context '{"oracle":{"age_sec":5,"max_age_sec":30}}'

python3 milestones/inspect_summary.py .artifacts/defi_milestone1_summary.json
python3 milestones/inspect_summary.py .artifacts/defi_milestone2_summary.json
python3 milestones/inspect_summary.py .artifacts/defi_milestone3_summary.json
python3 milestones/inspect_summary.py .artifacts/defi_milestone4_summary.json
python3 milestones/inspect_summary.py .artifacts/defi_milestone5_summary.json
